<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>D&D Character Sheet</title>
  <!-- React + ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- TailwindCSS (CDN build) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body {-webkit-tap-highlight-color: rgba(0,0,0,0);}
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance:textfield; }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script>
    (function () {
      const { useEffect, useMemo, useState, createElement: h, Fragment } = React;

      const STORAGE_KEY = "dnd.character.sheet.v2";

      const defaultSheet = {
        meta: { name: "Aria Nightbloom", class: "Rogue", level: 5, ancestry: "Half-Elf", background: "Urchin", alignment: "CN", profBonus: null },
        stats: { STR: 10, DEX: 18, CON: 14, INT: 12, WIS: 10, CHA: 14 },
        skills: [
          { name: "Acrobatics (Dex)", proficient: true },
          { name: "Stealth (Dex)", proficient: true },
          { name: "Perception (Wis)", proficient: false },
          { name: "Sleight of Hand (Dex)", proficient: true },
          { name: "Investigation (Int)", proficient: false }
        ],
        features: [
          { title: "Sneak Attack 3d6", notes: "Once/turn when you have adv or ally within 5 ft." },
          { title: "Cunning Action", notes: "Bonus action Dash/Disengage/Hide." },
          { title: "Uncanny Dodge", notes: "Reaction halve damage from an attacker you can see." }
        ],
        magicItems: [
          { name: "Cloak of Elvenkind", notes: "+adv Stealth, disadv to detect you", attuned: true },
          { name: "Dagger +1", notes: "+1 atk & dmg", attuned: false }
        ],
        combat: { hp: { current: 32, max: 38, temp: 0 }, ac: 16, speed: 30, initiative: 4, luck: 3 },
        notes: "Use this as a starter and customize everything in Edit mode."
      };

      function loadSheet() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : defaultSheet;
        } catch (e) {
          return defaultSheet;
        }
      }

      function saveSheet(sheet) {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(sheet)); } catch (e) {}
      }

      function clone(obj) {
        try { return structuredClone(obj); } catch (e) { return JSON.parse(JSON.stringify(obj)); }
      }

      function mod(score) {
        return Math.floor((Number(score || 10) - 10) / 2);
      }

      function abilityForSkill(name) {
        const n = name.toLowerCase();
        if (n.includes("acrobat") || n.includes("stealth") || n.includes("sleight")) return "DEX";
        if (n.includes("athletic")) return "STR";
        if (n.includes("perception") || n.includes("insight") || n.includes("survival") || n.includes("medicine") || n.includes("animal")) return "WIS";
        if (n.includes("arcana") || n.includes("history") || n.includes("investigation") || n.includes("nature") || n.includes("religion")) return "INT";
        if (n.includes("intimidation") || n.includes("performance") || n.includes("persuasion") || n.includes("deception")) return "CHA";
        return "DEX";
      }

      function skillBonus(skill, sheet, profBonus) {
        const abil = abilityForSkill(skill.name);
        const base = mod(sheet.stats[abil]);
        const pb = skill.proficient ? profBonus : 0;
        const total = base + pb;
        return (total >= 0 ? "+" : "") + total;
      }

      function Section(props) {
        return h("div", { className: "mb-4" },
          h("div", { className: "text-sm uppercase tracking-wider text-gray-500 mb-2" }, props.title),
          props.children
        );
      }

      function EditableList({ editMode, items, onChange }) {
        function updateItem(i, key, value) {
          onChange(items.map((it, idx) => (idx === i ? Object.assign({}, it, { [key]: value }) : it)));
        }
        function removeItem(i) { onChange(items.filter((_, idx) => idx !== i)); }

        const listNodes = items.map((it, i) => h("div", { key: i, className: "bg-white rounded-2xl shadow p-3" },
          editMode ? h("div", { className: "grid gap-2 sm:grid-cols-2" },
            h("input", {
              className: "rounded-xl border p-2",
              value: (it.title !== undefined ? it.title : (it.name || "")),
              placeholder: "Name",
              onChange: (e) => updateItem(i, (it.title !== undefined ? "title" : "name"), e.target.value)
            }),
            h("input", {
              className: "rounded-xl border p-2",
              value: it.notes || "",
              placeholder: "Notes",
              onChange: (e) => updateItem(i, "notes", e.target.value)
            }),
            ("attuned" in it) && h("label", { className: "flex items-center gap-2" },
              h("input", {
                type: "checkbox",
                checked: !!it.attuned,
                onChange: (e) => updateItem(i, "attuned", e.target.checked)
              }),
              " Attuned"
            ),
            h("div", { className: "sm:col-span-2 flex justify-end" },
              h("button", { className: "px-2 py-1 rounded-xl border", onClick: () => removeItem(i) }, "Remove")
            )
          ) : h(Fragment, null,
            h("div", { className: "font-medium flex items-center gap-2" },
              (it.title !== undefined ? it.title : it.name),
              (("attuned" in it) && it.attuned) && h("span", { className: "text-xs bg-violet-100 text-violet-800 px-2 py-0.5 rounded-full" }, "Attuned")
            ),
            it.notes ? h("div", { className: "text-sm text-gray-600" }, it.notes) : null
          )
        ));

        const addButton = editMode ? h("button", {
          className: "px-3 py-2 rounded-xl border",
          onClick: () => {
            const isMagic = items.length && items[0] && ("name" in items[0]);
            onChange([
              ...items,
              isMagic ? { name: "New Item", notes: "", attuned: false } : { title: "New", notes: "" }
            ]);
          }
        }, "+ Add") : null;

        return h("div", { className: "space-y-2" }, listNodes.concat(addButton ? [addButton] : []));
      }

      function HpBox({ sheet, update, nudge, editMode }) {
        return h("div", { className: "p-3 bg-white rounded-2xl shadow flex flex-col items-center" },
          h("div", { className: "text-xs uppercase tracking-wider text-gray-500" }, "HP"),
          h("div", { className: "flex items-center gap-2 mt-1" },
            h("button", { className: "rounded-xl border px-3 py-1", onClick: () => nudge("combat.hp.current", -1) }, "-"),
            h("div", { className: "text-2xl font-semibold tabular-nums" }, String(sheet.combat.hp.current)),
            h("button", { className: "rounded-xl border px-3 py-1", onClick: () => nudge("combat.hp.current", +1) }, "+")
          ),
          h("div", { className: "text-xs text-gray-600" },
            "/ " + sheet.combat.hp.max + (sheet.combat.hp.temp ? " (+" + sheet.combat.hp.temp + " temp)" : "")
          ),
          editMode ? h("div", { className: "flex gap-2 mt-2 text-sm" },
            h("label", { className: "flex items-center gap-1" },
              "Max",
              h("input", {
                className: "w-16 rounded-xl border p-1",
                type: "number",
                value: sheet.combat.hp.max,
                onChange: (e) => update("combat.hp.max", Number(e.target.value))
              })
            ),
            h("label", { className: "flex items-center gap-1" },
              "Temp",
              h("input", {
                className: "w-16 rounded-xl border p-1",
                type: "number",
                value: sheet.combat.hp.temp,
                onChange: (e) => update("combat.hp.temp", Number(e.target.value))
              })
            )
          ) : null
        );
      }

      function SimpleNudgeBox({ title, path, value, editMode, update, nudge, allowInput }) {
        return h("div", { className: "p-3 bg-white rounded-2xl shadow flex flex-col items-center" },
          h("div", { className: "text-xs uppercase tracking-wider text-gray-500" }, title),
          h("div", { className: "flex items-center gap-2 mt-1" },
            h("button", { className: "rounded-xl border px-3 py-1", onClick: () => nudge(path, -1) }, "-"),
            (allowInput && editMode)
              ? h("input", {
                  className: "text-2xl font-semibold tabular-nums w-16 text-center rounded-xl border p-1",
                  type: "number",
                  value: value,
                  onChange: (e) => update(path, Number(e.target.value))
                })
              : h("div", { className: "text-2xl font-semibold tabular-nums" }, String(value)),
            h("button", { className: "rounded-xl border px-3 py-1", onClick: () => nudge(path, +1) }, "+")
          )
        );
      }

      function CharacterSheet() {
        const [sheet, setSheet] = useState(loadSheet);
        const [editMode, setEditMode] = useState(false);

        useEffect(() => { saveSheet(sheet); }, [sheet]);

        const basePB = useMemo(() => Math.ceil((Number(sheet && sheet.meta ? sheet.meta.level : 1) + 7) / 4), [sheet && sheet.meta ? sheet.meta.level : 1]);
        const profBonus = (sheet && sheet.meta && sheet.meta.profBonus != null) ? sheet.meta.profBonus : basePB;

        function update(path, value) {
          setSheet((prev) => {
            const next = clone(prev);
            const parts = path.split(".");
            let obj = next;
            for (let i = 0; i < parts.length - 1; i++) obj = obj[parts[i]];
            obj[parts[parts.length - 1]] = value;
            return next;
          });
        }

        function nudge(path, delta) {
          setSheet((prev) => {
            const next = clone(prev);
            const parts = path.split(".");
            let obj = next;
            for (let i = 0; i < parts.length - 1; i++) obj = obj[parts[i]];
            const k = parts[parts.length - 1];
            obj[k] = Number(obj[k] || 0) + delta;
            return next;
          });
        }

        function StatCell({ label }) {
          return h("div", { className: "flex flex-col items-center p-3 rounded-2xl shadow bg-white" },
            h("div", { className: "text-xs uppercase tracking-wider text-gray-500" }, label),
            editMode ? h("input", {
              className: "mt-1 w-16 text-center text-2xl font-semibold rounded-xl border p-1",
              type: "number",
              value: sheet.stats[label],
              onChange: (e) => update("stats." + label, Number(e.target.value))
            }) : h("div", { className: "mt-1 text-2xl font-semibold" }, String(sheet.stats[label])),
            h("div", { className: "text-sm text-gray-600" }, "mod " + (mod(sheet.stats[label]) >= 0 ? "+" : "") + mod(sheet.stats[label]))
          );
        }

        const header = h("div", { className: "flex items-center justify-between gap-2 mb-4" },
          h("div", null,
            editMode ? h("div", { className: "grid grid-cols-2 gap-2" },
              h("input", {
                className: "rounded-xl border p-2",
                value: sheet.meta.name,
                placeholder: "Name",
                onChange: (e) => update("meta.name", e.target.value)
              }),
              h("input", {
                className: "rounded-xl border p-2",
                value: sheet.meta.class,
                placeholder: "Class",
                onChange: (e) => update("meta.class", e.target.value)
              }),
              h("input", {
                className: "rounded-xl border p-2",
                value: sheet.meta.ancestry,
                placeholder: "Ancestry",
                onChange: (e) => update("meta.ancestry", e.target.value)
              }),
              h("input", {
                className: "rounded-xl border p-2",
                value: sheet.meta.background,
                placeholder: "Background",
                onChange: (e) => update("meta.background", e.target.value)
              }),
              h("label", { className: "flex items-center gap-2" },
                "Lvl",
                h("input", {
                  className: "rounded-xl border p-2 w-20",
                  type: "number",
                  value: sheet.meta.level,
                  onChange: (e) => update("meta.level", Number(e.target.value))
                })
              ),
              h("input", {
                className: "rounded-xl border p-2",
                value: sheet.meta.alignment,
                placeholder: "Alignment",
                onChange: (e) => update("meta.alignment", e.target.value)
              }),
              h("label", { className: "flex items-center gap-2" },
                "PB",
                h("input", {
                  className: "rounded-xl border p-2 w-20",
                  type: "number",
                  value: (sheet.meta.profBonus == null ? "" : sheet.meta.profBonus),
                  placeholder: "auto " + basePB,
                  onChange: (e) => update("meta.profBonus", e.target.value === "" ? null : Number(e.target.value))
                })
              )
            ) : h("div", null,
              h("div", { className: "text-2xl font-bold" }, sheet.meta.name),
              h("div", { className: "text-sm text-gray-600" },
                sheet.meta.ancestry + " " + sheet.meta.class + " • Level " + sheet.meta.level + " • PB +" + profBonus
              )
            )
          ),
          h("button", { className: "px-3 py-2 rounded-xl shadow bg-white", onClick: () => setEditMode(v => !v) }, (editMode ? "Done" : "Edit"))
        );

        const quickBar = h("div", { className: "grid grid-cols-4 gap-3 mb-4" },
          h(HpBox, { sheet, update, nudge, editMode }),
          h(SimpleNudgeBox, { title: "Luck", path: "combat.luck", value: sheet.combat.luck, editMode, update, nudge, allowInput: false }),
          h(SimpleNudgeBox, { title: "AC", path: "combat.ac", value: sheet.combat.ac, editMode, update, nudge, allowInput: true }),
          h(SimpleNudgeBox, { title: "Speed", path: "combat.speed", value: sheet.combat.speed, editMode, update, nudge, allowInput: true })
        );

        const abilities = h("div", { className: "grid grid-cols-2 sm:grid-cols-3 gap-3 mb-4" },
          ["STR", "DEX", "CON", "INT", "WIS", "CHA"].map((s) => h(StatCell, { key: s, label: s }))
        );

        const skills = h(Section, { title: "Skills" },
          h(Fragment, null,
            sheet.skills.map((sk, i) => h("div", { key: i, className: "flex justify-between items-center bg-white p-3 rounded-2xl shadow mb-2" },
              editMode ? h(Fragment, null,
                h("input", {
                  className: "rounded-xl border p-2 flex-1 mr-2",
                  value: sk.name,
                  onChange: (e) => update("skills." + i + ".name", e.target.value)
                }),
                h("label", { className: "flex items-center gap-2 text-sm" },
                  h("input", {
                    type: "checkbox",
                    checked: !!sk.proficient,
                    onChange: (e) => update("skills." + i + ".proficient", e.target.checked)
                  }),
                  " Proficient"
                )
              ) : h("div", null,
                h("div", { className: "font-medium" }, sk.name),
                h("div", { className: "text-xs text-gray-600" }, (sk.proficient ? ("PB +" + profBonus) : "No prof"))
              ),
              (!editMode) && h("div", { className: "text-lg tabular-nums" }, skillBonus(sk, sheet, profBonus))
            )),
            editMode && h("button", {
              className: "px-3 py-2 rounded-xl border",
              onClick: () => setSheet(prev => Object.assign({}, prev, { skills: prev.skills.concat([{ name: "New Skill", proficient: false }]) }))
            }, "+ Add Skill")
          )
        );

        const features = h(Section, { title: "Features & Traits" },
          h(EditableList, { editMode, items: sheet.features, onChange: (next) => setSheet(p => Object.assign({}, p, { features: next })) })
        );

        const magic = h(Section, { title: "Magic Items" },
          h(EditableList, { editMode, items: sheet.magicItems, onChange: (next) => setSheet(p => Object.assign({}, p, { magicItems: next })) })
        );

        const notes = h(Section, { title: "Notes" },
          editMode ? h("textarea", {
            className: "w-full rounded-2xl border p-3 min-h-[120px]",
            value: sheet.notes,
            onChange: (e) => update("notes", e.target.value)
          }) : h("div", { className: "bg-white p-3 rounded-2xl shadow whitespace-pre-wrap" }, sheet.notes || "—")
        );

        const footer = h("div", { className: "mt-6 flex flex-wrap items-center gap-2 justify-between" },
          h("div", { className: "text-xs text-gray-500" }, "Data is saved locally on this device (localStorage).")
        );

        return h("div", { className: "min-h-screen bg-gray-50 text-gray-900 p-4 md:p-6" },
          h("div", { className: "max-w-3xl mx-auto" },
            header,
            quickBar,
            abilities,
            skills,
            features,
            magic,
            notes,
            footer
          )
        );
      }

      const rootEl = document.getElementById("root");
      const root = ReactDOM.createRoot(rootEl);
      root.render(h(CharacterSheet));

    })();
  </script>
</body>
</html>
